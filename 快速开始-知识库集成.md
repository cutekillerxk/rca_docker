# 快速开始：集成知识库检索功能

## 一、安装依赖

```bash
# 进入rca目录
cd D:\rca

# 安装必要的依赖（LangChain 1.0.7）
pip install langchain==1.0.7
pip install langchain-community      # FAISS在community包中
pip install faiss-cpu                # FAISS的实际实现
pip install sentence-transformers    # 嵌入模型
```

**重要说明**：
- LangChain 1.0后，FAISS移到了 `langchain-community` 包
- 必须安装 `faiss-cpu`，因为LangChain只是封装，不包含FAISS实现
- 详见：`LangChain-1.0.7-API说明.md`

## 二、快速测试
 
### 2.1 测试知识库检索

```python
# 测试脚本: test_kb.py
from lc_agent.knowledge_base import init_sample_knowledge, search_diagnosis_knowledge

# 初始化示例知识库
init_sample_knowledge()

# 测试搜索
result = search_diagnosis_knowledge(
    query="NameNode无法启动",
    expert_type="namenode",
    top_k=3
)
print(result)
```

运行：
```bash
python test_kb.py
```

### 2.2 测试工具匹配

```python
# 测试脚本: test_tool_matcher.py
from lc_agent.tool_matcher import get_tool_registry, match_tools_for_query

# 注册一些工具（示例）
registry = get_tool_registry()

def get_cluster_logs():
    """获取集群所有节点的最新日志内容"""
    pass

def get_node_log(node_name: str):
    """获取指定节点的日志内容"""
    pass

registry.register_tool("get_cluster_logs", get_cluster_logs, "获取集群所有节点的最新日志内容")
registry.register_tool("get_node_log", get_node_log, "获取指定节点的日志内容")

# 测试匹配
query = "NameNode无法启动，查看日志"
matched = match_tools_for_query(query, top_k=2)
print(f"查询: {query}")
print(f"匹配的工具: {matched}")
```

运行：
```bash
python test_tool_matcher.py
```

## 三、集成到现有Agent

### 方法1: 直接修改 agent.py

在 `agent.py` 中添加：

```python
# 在文件开头添加导入
from lc_agent.knowledge_base import search_diagnosis_knowledge

# 添加知识库检索工具
@tool("search_diagnosis_knowledge", description="从知识库检索诊断相关知识")
def search_diagnosis_knowledge_tool(query: str, expert_type: str = "all") -> str:
    """从知识库检索诊断相关知识"""
    return search_diagnosis_knowledge(query, expert_type)

# 修改 create_agent_instance 函数
def create_agent_instance(model_name: str = "qwen-8b"):
    llm = create_llm(model_name)
    
    # 原有工具
    tools = [
        get_cluster_logs,
        get_node_log,
        get_monitoring_metrics,
        website_search,
        hadoop_cluster_operation,
    ]
    
    # 添加知识库检索工具
    tools.append(search_diagnosis_knowledge_tool)
    
    # 更新系统提示词
    system_prompt = """你是HDFS集群问题诊断专家。

你可以使用 search_diagnosis_knowledge 工具从历史故障案例和Hadoop文档中检索相关知识。

**诊断建议**：
1. 遇到问题时，先使用 search_diagnosis_knowledge 检索相关知识
2. 然后获取相关日志和监控指标
3. 结合知识库知识和实际数据进行分析

请用专业、清晰的语言回答。"""
    
    agent = create_agent(
        model=llm,
        tools=tools,
        system_prompt=system_prompt
    )
    
    return agent
```

### 方法2: 使用 agent_with_kb.py

直接使用已创建的 `agent_with_kb.py`：

```python
from lc_agent.agent_with_kb import create_agent_with_kb

# 创建Agent
agent = create_agent_with_kb()

# 使用Agent
config = {"configurable": {"thread_id": "test_1"}}
result = agent.invoke(
    {"messages": [{"role": "user", "content": "NameNode无法启动，请诊断"}]},
    config=config
)
print(result['messages'][-1].content)
```

## 四、添加知识库内容

### 4.1 添加历史故障案例

```python
from lc_agent.knowledge_base import get_kb_manager

kb_manager = get_kb_manager()
history_kb = kb_manager.get_or_create_kb("HistoryCases")

# 添加案例
history_kb.add_texts(
    texts=[
        "案例1: NameNode无法启动，原因是配置文件hdfs-site.xml中端口配置错误，修改后恢复正常",
        "案例2: DataNode无法连接NameNode，原因是防火墙阻止了50010端口，开放端口后解决",
    ],
    metadatas=[
        {"source": "历史案例", "desc": "NameNode启动问题", "date": "2024-01-01"},
        {"source": "历史案例", "desc": "DataNode连接问题", "date": "2024-01-02"},
    ]
)

# 保存
history_kb.save()
```

### 4.2 从文件批量导入

```python
import json
from lc_agent.knowledge_base import get_kb_manager

kb_manager = get_kb_manager()
kb = kb_manager.get_or_create_kb("HistoryCases")

# 从JSON文件读取
with open("history_cases.json", "r", encoding="utf-8") as f:
    cases = json.load(f)

for case in cases:
    kb.add_texts(
        texts=[f"问题: {case['problem']}\n解决方案: {case['solution']}"],
        metadatas=[{
            "source": "历史案例",
            "desc": case.get("title", ""),
            "date": case.get("date", "")
        }]
    )

kb.save()
```

## 五、验证集成

运行你的Agent，测试知识库检索功能：

```python
# 测试脚本
from lc_agent.agent_with_kb import create_agent_with_kb
from lc_agent.knowledge_base import init_sample_knowledge

# 初始化知识库
init_sample_knowledge()

# 创建Agent
agent = create_agent_with_kb()

# 测试查询
queries = [
    "NameNode无法启动，请诊断",
    "DataNode连接失败，查看日志",
    "集群性能下降，分析原因",
]

for query in queries:
    print(f"\n{'='*60}")
    print(f"查询: {query}")
    print('='*60)
    
    config = {"configurable": {"thread_id": f"test_{hash(query)}"}}
    result = agent.invoke(
        {"messages": [{"role": "user", "content": query}]},
        config=config
    )
    
    print(result['messages'][-1].content)
```

## 六、常见问题

### Q: 提示找不到模块
**A**: 确保在rca目录下运行，或使用绝对导入：
```python
import sys
sys.path.append('D:/rca')
from lc_agent.knowledge_base import ...
```

### Q: FAISS安装失败
**A**: 使用CPU版本：
```bash
pip install faiss-cpu
```

### Q: sentence-transformers下载慢
**A**: 使用国内镜像或手动下载模型

### Q: 知识库搜索无结果
**A**: 
1. 确保已初始化知识库数据（运行 `init_sample_knowledge()`）
2. 检查查询字符串是否与知识库内容相关
3. 降低 `score_threshold` 参数

## 七、下一步

1. 收集真实的历史故障案例，构建知识库
2. 从Hadoop官方文档提取诊断知识
3. 根据实际使用效果调整参数
4. 考虑实现多智能体系统（如果需要）

