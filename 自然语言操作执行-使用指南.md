# 自然语言操作执行 - 使用指南

## 一、功能概述

系统现在支持理解自然语言并自动执行Hadoop集群操作，无需记忆具体的命令格式。

## 二、支持的指令类型

### 2.1 集群操作指令

**启动操作**：
- ✅ "启动NameNode"
- ✅ "启动整个集群"
- ✅ "开启DataNode1"
- ✅ "start namenode"（英文）

**停止操作**：
- ✅ "停止NameNode"
- ✅ "关闭整个集群"
- ✅ "停止DataNode2"
- ✅ "stop datanode1"（英文）

**重启操作**：
- ✅ "重启NameNode"
- ✅ "重新启动DataNode1"
- ✅ "restart namenode"（英文）

### 2.2 查询操作指令

**日志查询**：
- ✅ "查看NameNode日志"
- ✅ "获取DataNode1的日志"
- ✅ "显示集群所有日志"
- ✅ "查看所有节点日志"

**状态查询**：
- ✅ "查看集群状态"
- ✅ "获取监控指标"
- ✅ "显示集群监控数据"
- ✅ "检查集群健康状态"

### 2.3 诊断操作指令

**问题诊断**：
- ✅ "NameNode无法启动，帮我诊断"
- ✅ "集群性能下降，分析原因"
- ✅ "DataNode连接失败，排查问题"
- ✅ "分析NameNode的错误日志"

### 2.4 组合操作指令

**多步骤操作**：
- ✅ "先查看NameNode日志，如果有错误就重启它"
- ✅ "检查所有节点状态，如果有异常就重启"
- ✅ "查看集群日志，分析问题，然后给出解决方案"

## 三、使用方法

### 方法1：使用增强版Agent（推荐）

```python
from lc_agent.agent_nl_executor import create_agent_with_nl_executor

# 创建Agent
agent = create_agent_with_nl_executor()

# 使用自然语言指令
config = {"configurable": {"thread_id": "user_1"}}
result = agent.invoke(
    {"messages": [{"role": "user", "content": "重启NameNode"}]},
    config=config
)

print(result['messages'][-1].content)
```

### 方法2：直接使用执行器

```python
from lc_agent.natural_language_executor import execute_natural_language_command

# 执行自然语言命令
result = execute_natural_language_command("重启NameNode", auto_confirm=False)

if result["status"] == "requires_confirmation":
    print("需要确认操作")
    # 用户确认后
    result = execute_natural_language_command("重启NameNode", auto_confirm=True)
elif result["status"] == "success":
    print("操作成功:", result["result"])
```

### 方法3：集成到Gradio界面

修改 `gradio_demo.py`：

```python
from lc_agent.agent_nl_executor import create_agent_with_nl_executor

# 在init_agent函数中使用
def init_agent(model_name: str = "qwen-8b"):
    global agent
    agent = create_agent_with_nl_executor(model_name)  # 使用增强版
    return agent
```

## 四、工作原理

### 4.1 意图理解流程

```
用户输入："重启NameNode"
    ↓
[意图解析层]
    ├─ 知识库匹配（查找"重启NameNode"模板）
    ├─ 规则解析（提取"重启"和"NameNode"）
    └─ LLM理解（复杂指令）
    ↓
[参数提取]
    ├─ operation_type: "restart"
    ├─ target: "namenode"
    └─ parameters: {command: "restart", container: "namenode"}
    ↓
[安全验证]
    └─ 检查是否需要确认（重启操作需要确认）
    ↓
[执行层]
    └─ 调用 hadoop_cluster_operation("restart", "namenode")
    ↓
[反馈层]
    └─ 返回执行结果
```

### 4.2 知识库匹配

系统维护一个操作知识库，包含常见操作的模板：

```python
{
    "重启NameNode": {
        "operation_type": "restart",
        "target": "namenode",
        "command": "restart",
        "container": "namenode"
    },
    "查看NameNode日志": {
        "operation_type": "query",
        "tool": "get_node_log",
        "parameters": {"node_name": "NameNode"}
    },
    ...
}
```

### 4.3 规则解析

如果知识库没有匹配，使用规则解析：

1. **操作类型识别**：匹配关键词（启动/停止/重启）
2. **目标节点识别**：匹配节点名称（NameNode/DataNode1等）
3. **参数构建**：根据操作类型和目标构建参数

## 五、安全机制

### 5.1 操作确认

危险操作（停止、重启）需要用户确认：

```python
# 第一次调用
result = execute_natural_language_command("停止NameNode")
# 返回: {"status": "requires_confirmation", "message": "需要确认..."}

# 用户确认后
result = execute_natural_language_command("停止NameNode", auto_confirm=True)
# 执行操作
```

### 5.2 操作白名单

系统只允许执行预定义的安全操作：
- ✅ 启动/停止/重启节点
- ✅ 查看日志和监控
- ❌ 删除数据
- ❌ 格式化集群
- ❌ 修改配置（需要额外权限）

### 5.3 操作日志

所有操作都会记录日志，便于审计和追踪。

## 六、高级功能

### 6.1 自定义操作模板

可以添加自定义操作模板到知识库：

```python
from lc_agent.natural_language_executor import get_executor

executor = get_executor()
executor.mapper.operation_kb["我的自定义操作"] = {
    "operation_type": "restart",
    "target": "namenode",
    "command": "restart",
    "container": "namenode",
    "description": "我的自定义操作描述"
}
```

### 6.2 批量操作

```python
# 批量执行多个操作
commands = [
    "查看NameNode日志",
    "查看集群状态",
    "重启DataNode1"
]

for cmd in commands:
    result = execute_natural_language_command(cmd)
    print(f"{cmd}: {result['status']}")
```

### 6.3 条件执行

```python
# 先查询，根据结果决定是否执行
result = execute_natural_language_command("查看NameNode日志")
if "ERROR" in result.get("result", ""):
    # 有错误，执行重启
    execute_natural_language_command("重启NameNode", auto_confirm=True)
```

## 七、测试用例

### 7.1 基础操作测试

```python
test_cases = [
    ("重启NameNode", "restart namenode"),
    ("启动整个集群", "start cluster"),
    ("停止DataNode1", "stop datanode1"),
    ("查看NameNode日志", "query namenode logs"),
    ("查看集群状态", "query cluster status"),
]
```

### 7.2 复杂指令测试

```python
complex_cases = [
    "NameNode无法启动，先查看日志，然后重启",
    "检查所有节点状态，如果有异常就重启",
    "分析集群性能问题，给出优化建议",
]
```

## 八、常见问题

### Q1: 系统不理解我的指令怎么办？

**A**: 
1. 使用更明确的指令（如"重启NameNode"而不是"重启那个节点"）
2. 检查指令是否在支持列表中
3. 可以分步骤执行（先查询，再操作）

### Q2: 如何添加新的操作支持？

**A**: 
1. 在 `natural_language_executor.py` 的 `OperationMapper._init_operation_kb()` 中添加模板
2. 或者在知识库中添加新的操作文档

### Q3: 如何提高理解准确性？

**A**:
1. 使用知识库存储常见操作模板
2. 优化系统提示词
3. 使用更强的LLM模型（如GPT-4o）

### Q4: 危险操作如何控制？

**A**:
1. 系统会自动要求确认
2. 可以设置 `auto_confirm=False` 强制确认
3. 可以添加操作白名单限制

## 九、性能优化建议

1. **缓存操作模板**：常见操作模板可以缓存
2. **批量处理**：多个操作可以批量执行
3. **异步执行**：长时间操作可以异步执行
4. **结果缓存**：查询结果可以缓存一段时间

## 十、下一步改进

1. **多轮对话**：支持多轮对话澄清意图
2. **操作历史**：记录操作历史，支持撤销
3. **智能推荐**：根据上下文推荐操作
4. **语音输入**：支持语音指令（未来）

## 十一、总结

✅ **功能已实现**：系统现在可以理解自然语言并执行Hadoop集群操作

✅ **安全可靠**：危险操作需要确认，操作有日志记录

✅ **易于使用**：无需记忆命令格式，直接说需求即可

✅ **可扩展**：可以轻松添加新的操作支持

**推荐使用方式**：集成到Gradio界面，用户可以直接在Web界面使用自然语言操作集群。

