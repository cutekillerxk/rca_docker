## 项目现状说明

用于在新会话中快速理解项目状态、目标与当前实现。

### 1. 项目目标与定位
- 目标：Hadoop 集群故障**检测**（优先）与诊断能力提升，多智能体框架 + 统一数据集微调。
- 当前输出风格：对话式文本（非 JSON），便于人工阅读。
- 原则：除非明确要求，不主动写文件；不做破坏性操作。

### 2. 运行环境与基本信息
- OS：linux 3.10.0-1160.el7.x86_64
- Conda 环境：`rca`
- 仓库路径：`/media/hnu/hnu2025/xiongkui/rca_docker/rca-main`
- Hadoop 版本：3.3.6（Docker Compose）

### 3. 当前关键模块

#### 3.1 旧框架（LangChain）
- 位置：`cl_agent/agent.py`
- 现状：仍可用，但被认为不利于流程控制（黑盒）。
- 相关工具：`cl_agent/tools/tools.py`（LangChain @tool 装饰器）

#### 3.2 新框架（自建多智能体）
- 位置：`mutli_agent/`（目录名拼写为 mutli_agent）
- 目标：分类 → 多专家并行 → 讨论汇总
- 核心文件：
  - `mutli_agent/base.py`：BaseAgent（极简，Role Token 支持）
  - `mutli_agent/llm_client.py`：LLM 直接调用封装（替代 LangChain）
  - `mutli_agent/orchestrator.py`：总协调器（流程控制 + 并行专家 + 讨论汇总）
  - `mutli_agent/agents/classifier.py`：分类 Agent
  - `mutli_agent/agents/discussion.py`：Discussion Agent（综合专家结果）
  - `mutli_agent/agents/experts/hdfs_expert.py`：HDFS 专家（已实现）
  - `mutli_agent/utils/context_collector.py`：全局上下文收集（日志 + 监控）
  - `mutli_agent/utils/expert_selector.py`：专家选择器
  - `mutli_agent/utils/tool_adapter.py`：工具适配（复用 cl_agent/tools）
  - `mutli_agent/utils/response_formatter.py`：输出格式辅助

#### 3.3 已实现与未实现
- 已实现：Classifier、Discussion、HDFS Expert、Orchestrator、上下文收集、工具适配
- 未实现（TODO）：YARN Expert、MapReduce Expert、Network Expert、Generic Expert

### 4. 故障类型与知识库
- 故障类型库：`cl_agent/config.py` → `FAULT_TYPE_LIBRARY`
- 已覆盖 10 个经典故障（HDFS/YARN/MapReduce）

### 5. 日志读取与过滤机制
- 日志读取：`cl_agent/log_reader.py`
- 重要 INFO/WARN 白名单保留：过滤掉大部分 INFO，但保留关键状态变化日志
- 日志状态文件：`logs/log_reader_state.json`

### 6. 数据集与测试用例

#### 6.1 数据集
- 路径：`Dataset/`
- 形式：Instruction-Following
- 方向：统一数据集 + Role Token（分类样本 + 诊断样本混训）

#### 6.2 测试用例
- 路径：`test_cases/`
- 结构：按故障类型分层，case 目录下有 `cluster_logs.txt` 与 `return.txt`
- 手动复现指南：`test_cases/故障复现操作指南.md`

### 7. 多智能体设计要点
- 采用 “分类 Agent → 多专家并行 → Discussion 汇总” 会诊流程
- 全局上下文注入：每个专家看到日志 + 监控 + 集群状态
- 支持联动故障：Discussion Agent 综合多专家结论

### 8. 已知改动与注意事项
- 已移除强制 JSON 输出（对话式输出优先）
- 修复 Log 文件匹配模式（避免 historyserver 误匹配）
- `update_log_state.py` 已修复“新增行数/读取位置”问题
- 强调：除非明确要求，不写新文件、不删除文件

### 9. 近期计划（高优先级）
1. 完成 YARN / MapReduce / Network 专家 Agent
2. 增强 Discussion Agent（冲突处理 + 联动分析）
3. 完善 unified dataset（加入 role 字段与复合故障样本）
4. 对接 gradio 或 CLI 入口使用新框架

### 10. 使用入口建议
- 新框架入口：`mutli_agent/orchestrator.py`（FaultOrchestrator）
- 旧框架入口：`cl_agent/gradio_demo.py`（LangChain）

### 11. 用户偏好
- “以后不要你写文件就不要写文件”
- 默认不改动无关文件
- 诊断优先，修复仅在明确要求时提供

